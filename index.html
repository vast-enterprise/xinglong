<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>3D模型查看器</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meshoptimizer@0.18.1/meshopt_decoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
        font-family: Arial, sans-serif;
      }
      .container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        padding: 15px;
        max-width: 1400px;
        margin: 0 auto;
      }
      .model-card {
        background: white;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 400px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .model-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }
      .model-viewer {
        flex: 1;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        background: #f0f0f0;
        margin-bottom: 10px;
        min-height: 300px;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
      }
      .task-info {
        padding: 8px;
        background: #f8f8f8;
        border-radius: 5px;
        margin-top: auto;
      }
      .task-id {
        font-family: monospace;
        color: #333;
        font-size: 12px;
        word-break: break-all;
        margin-bottom: 8px;
      }
      .copy-button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.3s;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
      }
      .pagination button {
        padding: 5px 15px;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        border-radius: 4px;
      }
      .pagination button:disabled {
        background: #f0f0f0;
        cursor: not-allowed;
      }
      .error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container" id="modelGrid"></div>
    <div class="pagination">
      <button id="prevPage" onclick="changePage(-1)">上一页</button>
      <span id="pageInfo">第 1 页</span>
      <button id="nextPage" onclick="changePage(1)">下一页</button>
    </div>

    <script>
      // 防止外部脚本错误影响我们的应用
      window.onerror = function (message, source, lineno, colno, error) {
        console.log("捕获到错误:", message);
        // 返回true表示我们已经处理了这个错误
        return true;
      };

      // 拦截某些可能导致错误的请求
      const originalFetch = window.fetch;
      window.fetch = function (url, options) {
        if (url.includes("hybridaction") || url.includes("zybTracker")) {
          console.log("拦截请求:", url);
          return Promise.resolve(
            new Response(JSON.stringify({}), {
              status: 200,
              headers: { "Content-Type": "application/json" },
            })
          );
        }
        return originalFetch(url, options);
      };

      let currentPage = 1;
      const pageSize = 10;
      let totalItems = 0;

      function updatePagination() {
        const totalPages = Math.ceil(totalItems / pageSize);
        document.getElementById(
          "pageInfo"
        ).textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页 (总计: ${totalItems} 个模型)`;
        document.getElementById("prevPage").disabled = currentPage <= 1;
        document.getElementById("nextPage").disabled =
          currentPage >= totalPages;
      }

      function showError(message) {
        const container = document.getElementById("modelGrid");
        container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 20px; background: #ffeeee; border: 1px solid #ffcccc; border-radius: 5px; margin: 20px;">
                    <h3 style="color: #cc0000;">加载失败</h3>
                    <p>${message}</p>
                    <button onclick="loadModels(1)" style="margin-top: 10px; padding: 5px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        重试
                    </button>
                </div>
            `;
      }

      if (typeof MeshoptDecoder !== "undefined") {
        console.log("MeshoptDecoder 已加载");
      } else {
        console.error("MeshoptDecoder 未加载，尝试动态加载");
        const script = document.createElement("script");
        script.src =
          "https://cdn.jsdelivr.net/npm/meshoptimizer@0.18.1/meshopt_decoder.js";
        script.onload = function () {
          console.log("MeshoptDecoder 动态加载成功");
          loadModels(currentPage);
        };
        document.head.appendChild(script);
      }

      async function loadModels(page) {
        try {
          const container = document.getElementById("modelGrid");
          container.innerHTML =
            '<div style="grid-column: 1 / -1; text-align: center; padding: 20px;">等待20s……此刻正在自动登陆……模型加载中…………</div>';

          const response = await fetch(
            `/api/tasks?page=${page}&page_size=${pageSize}`
          );
          const data = await response.json();

          console.log("API响应:", data); // 添加日志

          if (data.code === 0) {
            container.innerHTML = "";
            totalItems = data.data.total;
            updatePagination();

            if (data.data.items.length === 0) {
              container.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 20px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 5px; margin: 20px;">
                                <h3>没有找到模型</h3>
                                <p>请确保task_id.txt文件中包含有效的任务ID</p>
                            </div>
                        `;
              return;
            }

            // 显示找到的模型数量
            const infoDiv = document.createElement("div");
            infoDiv.style.gridColumn = "1 / -1";
            infoDiv.style.textAlign = "center";
            infoDiv.style.padding = "10px";
            infoDiv.style.marginBottom = "15px";
            infoDiv.innerHTML = `<h3>这里有 ${totalItems} 个模型</h3>`;
            container.appendChild(infoDiv);

            // 遍历并创建每个模型的查看器
            data.data.items.forEach((item) => {
              console.log(`创建模型查看器: ${item.task_id}`);
              createModelViewer(
                item.task_id,
                item.model,
                item.thumbnail,
                item.name
              );
            });
          } else {
            showError(`API返回错误: ${data.message}`);
          }
        } catch (error) {
          console.error("加载模型时出错:", error);
          showError(`加载失败: ${error.message}`);
        }
      }

      function createModelViewer(taskId, modelUrl, thumbnailUrl, modelName) {
        if (!modelUrl) {
          console.error(`没有为任务 ${taskId} 提供模型URL`);
          return;
        }

        console.log(`创建模型查看器，任务ID: ${taskId}, 模型URL: ${modelUrl}`);

        const card = document.createElement("div");
        card.className = "model-card";

        const viewer = document.createElement("div");
        viewer.className = "model-viewer";
        viewer.id = `viewer-${taskId}`;

        const loading = document.createElement("div");
        loading.className = "loading";
        loading.textContent = "加载中...";
        viewer.appendChild(loading);

        const taskInfo = document.createElement("div");
        taskInfo.className = "task-info";

        // 添加模型名称（如果有）
        if (modelName) {
          const nameDiv = document.createElement("div");
          nameDiv.style.fontWeight = "bold";
          nameDiv.style.marginBottom = "5px";
          nameDiv.textContent = modelName;
          taskInfo.appendChild(nameDiv);
        }

        const taskIdSpan = document.createElement("div");
        taskIdSpan.className = "task-id";
        taskIdSpan.textContent = `TaskID: ${taskId}`;

        const copyButton = document.createElement("button");
        copyButton.className = "copy-button";
        copyButton.textContent = "复制TaskID";
        copyButton.onclick = () => {
          navigator.clipboard
            .writeText(taskId)
            .then(() => {
              copyButton.textContent = "已复制!";
              setTimeout(() => (copyButton.textContent = "复制ID"), 2000);
            })
            .catch((err) => console.error("复制失败:", err));
        };

        taskInfo.appendChild(taskIdSpan);
        taskInfo.appendChild(copyButton);

        card.appendChild(viewer);
        card.appendChild(taskInfo);
        document.getElementById("modelGrid").appendChild(card);

        try {
          const scene = new THREE.Scene();
          scene.background = new THREE.Color(0xf0f0f0);

          const camera = new THREE.PerspectiveCamera(
            45,
            viewer.clientWidth / viewer.clientHeight,
            0.1,
            1000
          );
          camera.fov = 5;
          camera.updateProjectionMatrix(); // 更新相机

          const renderer = new THREE.WebGLRenderer({ antialias: true });
          renderer.setSize(viewer.clientWidth, viewer.clientHeight);
          viewer.appendChild(renderer.domElement);

          const controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;

          const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
          scene.add(ambientLight);

          const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
          directionalLight.position.set(0, 0, 10);
          scene.add(directionalLight);

          // 确保在创建加载器之前设置MeshoptDecoder
          const loader = new THREE.GLTFLoader();
          if (typeof MeshoptDecoder !== "undefined") {
            console.log(`为任务 ${taskId} 设置 MeshoptDecoder`);
            loader.setMeshoptDecoder(MeshoptDecoder);
          } else {
            console.error(`任务 ${taskId} 的 MeshoptDecoder 未加载`);
          }

          const proxyUrl = `/proxy/model?url=${encodeURIComponent(modelUrl)}`;
          console.log(`加载模型，任务ID: ${taskId}, 代理URL: ${proxyUrl}`);

          loader.load(
            proxyUrl,
            (gltf) => {
              console.log(`模型加载成功，任务ID: ${taskId}`);
              loading.remove();
              const model = gltf.scene;
              scene.add(model);

              const box = new THREE.Box3().setFromObject(model);
              const center = box.getCenter(new THREE.Vector3());
              const size = box.getSize(new THREE.Vector3());
              const maxDim = Math.max(size.x, size.y, size.z);
              const fov = camera.fov * (Math.PI / 180);
              let cameraZ = Math.abs(maxDim / Math.sin(fov / 2));
              camera.position.z = cameraZ * 0.5; // 将系数调小为0.8，使相机更靠近模型
              camera.lookAt(center);

              function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
              }
              animate();
            },
            (xhr) => {
              const percent = (xhr.loaded / xhr.total) * 100;
              console.log(
                `模型加载进度，任务ID: ${taskId}, 进度: ${Math.round(percent)}%`
              );
              loading.textContent = `加载中... ${Math.round(percent)}%`;
            },
            (error) => {
              console.error(`加载模型失败，任务ID: ${taskId}:`, error);
              loading.textContent = "加载失败";
              loading.style.background = "rgba(255, 0, 0, 0.7)";
            }
          );

          // 处理窗口大小变化
          window.addEventListener("resize", () => {
            if (renderer) {
              const width = viewer.clientWidth;
              const height = viewer.clientHeight;
              camera.aspect = width / height;
              camera.updateProjectionMatrix();
              renderer.setSize(width, height);
            }
          });
        } catch (error) {
          console.error(`设置3D查看器时出错，任务ID: ${taskId}:`, error);
          loading.textContent = "初始化失败";
          loading.style.background = "rgba(255, 0, 0, 0.7)";
        }
      }

      function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 1) {
          currentPage = newPage;
          loadModels(currentPage);
        }
      }

      // 初始加载
      loadModels(1);
    </script>
  </body>
</html>
